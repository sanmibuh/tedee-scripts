# tedee-scripts

Shell scripts for controlling Tedee Smart Locks via the Tedee Bridge API.

## üìÅ Project Structure

```
tedee-scripts/
‚îú‚îÄ‚îÄ bin/                    # Executable scripts
‚îÇ   ‚îú‚îÄ‚îÄ close              # Close/lock the door
‚îÇ   ‚îî‚îÄ‚îÄ update             # Update repository
‚îú‚îÄ‚îÄ config/                 # Configuration files
‚îÇ   ‚îî‚îÄ‚îÄ tedee.conf         # Your config (not in git, generated by setup)
‚îú‚îÄ‚îÄ lib/                    # Shared libraries
‚îÇ   ‚îî‚îÄ‚îÄ tedee-common.sh    # Common functions
‚îú‚îÄ‚îÄ locales/                # Internationalization (i18n)
‚îÇ   ‚îú‚îÄ‚îÄ en.sh              # English messages
‚îÇ   ‚îî‚îÄ‚îÄ es.sh              # Spanish messages
‚îú‚îÄ‚îÄ setup.sh               # Interactive setup
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ LICENSE
```

## üöÄ Quick Start

### 1. Configuration

Run the interactive setup script:

```bash
./setup.sh
```

The setup script will:
- Guide you through entering all required settings
- Validate mandatory parameters (Bridge IP, API Token, Device ID)
- Optionally configure Telegram notifications
- Configure your preferred language (English or Spanish)
- Create the configuration file automatically
- Make all scripts executable

To reconfigure later, simply run `./setup.sh` again.

#### Language Configuration

The scripts support multiple languages for Telegram notifications:
- **English (en)** - Default
- **Spanish (es)**

During setup, you'll be prompted to choose your preferred locale. Available options are displayed, and only valid locales can be selected.

You can change the language later by:
1. Running `./setup.sh` again and selecting a new locale
2. Manually editing `config/tedee.conf` and changing the `LOCALE` value

To reconfigure later, simply run `./setup.sh` again.

### 2. Usage

Close/lock the door:
```bash
./bin/close
```

Update to the latest version:
```bash
./bin/update
```

Update from a specific branch:
```bash
./bin/update develop
```

**Note:** The update script downloads the latest version from GitHub using `curl`.

### 3. Schedule with Crontab

The main purpose of these scripts is automation via crontab. Examples:

```bash
# Edit your crontab
crontab -e

# Auto-close door every night at 10 PM
0 22 * * * /path/to/tedee-scripts/bin/close

# Auto-close door every weekday at 11 PM
0 23 * * 1-5 /path/to/tedee-scripts/bin/close

# Auto-close on weekends at midnight
0 0 * * 6,0 /path/to/tedee-scripts/bin/close >> /tmp/tedee-close.log 2>&1
```

**Tip:** Use absolute paths in crontab for reliability.

### 4. Alternative: Crontab UI with Docker

For easier management of cron jobs through a web interface, you can use [crontab-ui](https://github.com/alseambusher/crontab-ui) with Docker Compose.

#### Create docker-compose.yml

Create a `docker-compose.yml` file in your preferred location:

```yaml
services:
  crontab-ui:
    image: alseambusher/crontab-ui:latest
    container_name: crontab-ui
    restart: unless-stopped
    environment:
      - TZ=Europe/Madrid  # Set your timezone
      - BASIC_AUTH_USER=  # Set your username for web interface
      - BASIC_AUTH_PWD=   # Set your password for web interface
    ports:
      - "8000:8000"
    volumes:
      - /path/to/tedee:/scripts/tedee  # Mount your tedee-scripts directory
    
    # Health check to ensure the service is running
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
```

#### Configuration

- **TZ**: Set your timezone (e.g., `Europe/Madrid`, `America/New_York`)
- **BASIC_AUTH_USER**: Username for web interface authentication
- **BASIC_AUTH_PWD**: Password for web interface authentication
- **volumes**: Mount the tedee-scripts directory to `/scripts/tedee` in the container
  - Replace `/path/to/tedee` with the absolute path to your tedee-scripts directory

#### Start the Service

```bash
# Start the container
docker compose up -d

# Check the logs
docker compose logs -f

# Stop the container
docker compose down
# Note: On older setups, you may need to use `docker-compose` instead of `docker compose`.
```

#### Access the Web Interface

Open your browser and navigate to: `http://localhost:8000`

Login with the credentials you set in `BASIC_AUTH_USER` and `BASIC_AUTH_PWD`.

#### Adding Cron Jobs via UI

In the web interface, you can add cron jobs that run your tedee scripts:

- **Expression**: `0 22 * * *` (10 PM every day)
- **Command**: `/scripts/tedee/bin/close`
- **Name**: Auto-close door at night

The UI provides a visual cron expression builder and validation to make scheduling easier.

### 5. Optional: Add to PATH

To run scripts from anywhere, add the bin directory to your PATH:

```bash
# Add to your ~/.zshrc or ~/.bashrc
export PATH="$HOME/Projects/opensource/tedee-scripts/bin:$PATH"
```

Then you can run:
```bash
close
update
```

## üìã Requirements

- `curl` - For API requests and downloading updates
- `sha256sum` - For API token generation (or `shasum -a 256` on macOS)
- `ping` - For bridge connectivity checks
- `tar` - For extracting updates (usually pre-installed)

## üîß Features

### Close Script (`bin/close`)
- Checks bridge connectivity before attempting to close
- Retries on failure (configurable)
- Reports lock status
- Optional Telegram notifications
- Validates door state before and after closing
- Perfect for crontab automation

### Common Library (`lib/tedee-common.sh`)
- Shared functions for all Tedee scripts
- Bridge communication and API key generation
- Lock state checking and waiting
- Telegram notification support
- Configuration validation
- Internationalization (i18n) support with multiple locales

## üõ†Ô∏è Development

The project is structured to make it easy to add new scripts:

1. Create a new script in `bin/`
2. Source the common library: `. "$SCRIPT_DIR/lib/tedee-common.sh"`
3. Use shared functions like `load_config()`, `get_lock_state()`, etc.
4. Make it executable: `chmod +x bin/your-script`

## üìù Documentation

- **README.md** - This file (full documentation)
- **QUICK_REFERENCE.md** - Quick commands, troubleshooting, and tips

## üìù License

See LICENSE file for details.

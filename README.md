# tedee-scripts

Shell scripts for controlling Tedee Smart Locks via the Tedee Bridge API.

## üìÅ Project Structure

```
tedee-scripts/
‚îú‚îÄ‚îÄ bin/                    # Executable scripts
‚îÇ   ‚îú‚îÄ‚îÄ callback           # Webhook event handler
‚îÇ   ‚îú‚îÄ‚îÄ close              # Close/lock the door
‚îÇ   ‚îî‚îÄ‚îÄ update             # Update repository
‚îú‚îÄ‚îÄ config/                 # Configuration files
‚îÇ   ‚îî‚îÄ‚îÄ tedee.conf         # Your config (not in git, generated by setup)
‚îú‚îÄ‚îÄ lib/                    # Shared libraries
‚îÇ   ‚îî‚îÄ‚îÄ tedee-common.sh    # Common functions
‚îú‚îÄ‚îÄ locales/                # Internationalization (i18n)
‚îÇ   ‚îú‚îÄ‚îÄ en.sh              # English messages
‚îÇ   ‚îî‚îÄ‚îÄ es.sh              # Spanish messages
‚îú‚îÄ‚îÄ setup.sh               # Interactive setup
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ QUICK_REFERENCE.md
‚îî‚îÄ‚îÄ LICENSE
```

## üöÄ Quick Start

### 1. Configuration

Run the interactive setup script:

```bash
./setup.sh
```

The setup script will:
- Guide you through entering all required settings
- Validate mandatory parameters (Bridge IP, API Token, Device ID)
- Optionally configure Telegram notifications
- Configure your preferred language (English or Spanish)
- Create the configuration file automatically
- Make all scripts executable

To reconfigure later, simply run `./setup.sh` again.

### 2. Usage

Close/lock the door:
```bash
./bin/close
```

Handle webhook events (for Tedee Bridge API webhooks):
```bash
./bin/callback <event> <timestamp> <data>
```

Update to the latest version:
```bash
./bin/update
```

Update from a specific branch:
```bash
./bin/update develop
```

**Note:** The update script downloads the latest version from GitHub using `curl`.

### 3. Schedule with Crontab

The main purpose of these scripts is automation via crontab. Examples:

```bash
# Edit your crontab
crontab -e

# Auto-close door every night at 10 PM
0 22 * * * /path/to/tedee-scripts/bin/close

# Auto-close door every weekday at 11 PM
0 23 * * 1-5 /path/to/tedee-scripts/bin/close

# Auto-close on weekends at midnight
0 0 * * 6,0 /path/to/tedee-scripts/bin/close >> /tmp/tedee-close.log 2>&1
```

**Tip:** Use absolute paths in crontab for reliability.

### 4. Alternative: Crontab UI with Docker

For easier management of cron jobs through a web interface, you can use [crontab-ui](https://github.com/alseambusher/crontab-ui) with Docker Compose.

#### Create docker-compose.yml

Create a `docker-compose.yml` file in your preferred location:

```yaml
services:
  crontab-ui:
    image: alseambusher/crontab-ui:latest
    container_name: crontab-ui
    restart: unless-stopped
    environment:
      - TZ=Europe/Madrid  # Set your timezone
      - BASIC_AUTH_USER=  # Set your username for web interface
      - BASIC_AUTH_PWD=   # Set your password for web interface
    ports:
      - "8000:8000"
    volumes:
      - /path/to/tedee:/scripts/tedee  # Mount your tedee-scripts directory
    
    # Health check to ensure the service is running
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
```

#### Configuration

- **TZ**: Set your timezone (e.g., `Europe/Madrid`, `America/New_York`)
- **BASIC_AUTH_USER**: Username for web interface authentication
- **BASIC_AUTH_PWD**: Password for web interface authentication
- **volumes**: Mount the tedee-scripts directory to `/scripts/tedee` in the container
  - Replace `/path/to/tedee` with the absolute path to your tedee-scripts directory

#### Start the Service

```bash
# Start the container
docker compose up -d

# Check the logs
docker compose logs -f

# Stop the container
docker compose down
# Note: On older setups, you may need to use `docker-compose` instead of `docker compose`.
```

#### Access the Web Interface

Open your browser and navigate to: `http://localhost:8000`

Login with the credentials you set in `BASIC_AUTH_USER` and `BASIC_AUTH_PWD`.

#### Adding Cron Jobs via UI

In the web interface, you can add cron jobs that run your tedee scripts:

- **Expression**: `0 22 * * *` (10 PM every day)
- **Command**: `/scripts/tedee/bin/close`
- **Name**: Auto-close door at night

The UI provides a visual cron expression builder and validation to make scheduling easier.

### 5. Optional: Add to PATH

To run scripts from anywhere, add the bin directory to your PATH:

```bash
# Add to your ~/.zshrc or ~/.bashrc
export PATH="path/to/tedee-scripts/bin:$PATH"
```

Then you can run:
```bash
close
update
```

## ü§ñ Setting Up Telegram Notifications (Optional)

To receive notifications about lock events via Telegram, you need to create a Telegram bot and obtain the necessary credentials.

### 1. Create a Telegram Bot

1. Open Telegram and search for **@BotFather** (the official bot for creating bots)
2. Start a chat with BotFather and send the command: `/newbot`
3. Follow the prompts:
   - Choose a name for your bot (e.g., "My Tedee Lock Bot")
   - Choose a username for your bot (must end in 'bot', e.g., "my_tedee_lock_bot")
4. BotFather will respond with a message containing your **Bot Token**
   - It looks like: `123456789:ABCdefGhIJKlmNoPQRsTUVwxyZ`
   - **Save this token** - you'll need it for configuration

### 2. Get Your Chat ID

To find your Chat ID (the ID of the chat where notifications will be sent):

**Method 1: Using userinfobot**
1. Search for **@userinfobot** in Telegram
2. Start a chat and send any message
3. The bot will reply with your user information, including your **Chat ID**
   - It looks like: `123456789`

**Method 2: Using your bot and the Telegram API**
1. Send a message to your newly created bot (any message works)
2. Open this URL in your browser (replace `YOUR_BOT_TOKEN` with your actual token):
   ```
   https://api.telegram.org/botYOUR_BOT_TOKEN/getUpdates
   ```
3. Look for the `"chat":{"id":` field in the JSON response
   - Example: `"chat":{"id":123456789,...}`

### 3. Configure in tedee-scripts

Once you have your Bot Token and Chat ID:

1. Run the setup script: `./setup.sh`
2. When prompted for Telegram configuration:
   - Enter your **Bot Token** when asked
   - Enter your **Chat ID** when asked
3. The setup will save these credentials to your config file

Alternatively, you can manually add them to `config/tedee.conf`:
```bash
TELEGRAM_BOT_TOKEN="123456789:ABCdefGhIJKlmNoPQRsTUVwxyZ"
TELEGRAM_CHAT_ID="123456789"
```

### 4. Test Your Configuration

Test that notifications work:
```bash
# The close script will send a Telegram notification if configured
./bin/close

# Or test with a webhook callback event
./bin/callback "lock-status-changed" "2023-07-25T14:41:48.825Z" '{"deviceId":289001,"state":6}'
```

You should receive a notification in your Telegram chat!

**Note:** Telegram notifications are optional. If not configured, the scripts will work normally without sending notifications.

## üìã Requirements

- `curl` - For API requests and downloading updates
- `sha256sum` - For API token generation (or `shasum -a 256` on macOS)
- `ping` - For bridge connectivity checks
- `tar` - For extracting updates (usually pre-installed)

## üîß Features

### Callback Script (`bin/callback`)
- Receives webhook events from Tedee Bridge API
- Handles all event types from the [Tedee API documentation](https://github.com/tedee-com/tedee-documentation/blob/master/bridge-api/webhooks/events.md)
- Sends Telegram notifications for each event

#### Supported Events:
- `backend-connection-changed` - Bridge connection to backend changes (connected/disconnected)
- `device-connection-changed` - Device connection status to bridge changes (connected/disconnected)
- `device-settings-changed` - Device settings are modified
- `lock-status-changed` - Lock state changes (includes lock status, jammed status, and door state)
- `device-battery-level-changed` - Battery level changes significantly
- `device-battery-fully-charged` - Battery reaches 100%
- `device-battery-start-charging` - Device starts charging
- `device-battery-stop-charging` - Device stops charging

For complete event documentation, see the [official Tedee webhook events documentation](https://github.com/tedee-com/tedee-documentation/blob/master/bridge-api/webhooks/events.md).

#### Testing the Callback:
```bash
# Test with a sample event (ISO 8601 timestamp format)
./bin/callback "lock-status-changed" "2023-07-25T14:41:48.825Z" '{"deviceId":289001,"state":6}'
```

### Close Script (`bin/close`)
- Checks bridge connectivity before attempting to close
- Retries on failure (configurable)
- Reports lock status
- Optional Telegram notifications
- Validates door state before and after closing
- Perfect for crontab automation

### Common Library (`lib/tedee-common.sh`)
- Shared functions for all Tedee scripts
- Bridge communication and API key generation
- Lock state checking and waiting
- Telegram notification support
- Configuration validation
- Internationalization (i18n) support with multiple locales

## üõ†Ô∏è Development

The project is structured to make it easy to add new scripts:

1. Create a new script in `bin/`
2. Source the common library: `. "$SCRIPT_DIR/lib/tedee-common.sh"`
3. Use shared functions like `load_config()`, `get_lock_state()`, etc.
4. Make it executable: `chmod +x bin/your-script`

## üìù Documentation

- **README.md** - This file (full documentation)
- **QUICK_REFERENCE.md** - Quick commands, troubleshooting, and tips

## üìù License

See LICENSE file for details.
